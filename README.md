# Телеграм-бот Billion Roadmap

Этот проект — небольшой телеграм-бот на Go. Он отправляет запланированные сообщения, которые генерируются с помощью OpenAI. По умолчанию бот публикует два дайджеста в день. Время контролируется переменными окружения `LUNCH_TIME` и `BRIEF_TIME` (значения по умолчанию `13:00` и `20:00`). Список задач можно полностью настроить через `TASKS_FILE` или `TASKS_JSON`.

* **13:00 MSK** – план идей на обед
* **20:00 MSK** – ежедневный краткий обзор (юг МО, Бутово/Щербинка/Подольск/Воскресенск)

Бот можно развернуть на любой постоянно работающей площадке: Railway, Fly.io или VPS.

## Команды

- `/chat <сообщение>` – задать боту вопрос и получить ответ от OpenAI.
- `/ping` – проверка состояния, в ответ приходит `pong`.
- `/model [имя]` – показать или сменить модель генерации (по умолчанию `gpt-4o`).
- `/lunch` – немедленно запросить идеи на обед.
- `/brief` – немедленно запросить вечерний дайджест.
- `/tasks` – вывести текущее расписание задач.

Команда `/model` управляет выбором модели OpenAI. Без аргументов она выводит текущую модель и список поддерживаемых идентификаторов из библиотеки `go-openai`. Полный перечень находится в [MODELS.md](MODELS.md). Чтобы переключить модель, передайте её имя, например:

```bash
/model gpt-4-turbo
```

## Требования

* Go 1.24+
* Токен телеграм-бота (`TELEGRAM_TOKEN`)
* ID целевого чата (`CHAT_ID`)
* Ключ API OpenAI (`OPENAI_API_KEY`)
* Имя модели OpenAI (`OPENAI_MODEL`, опционально, по умолчанию `gpt-4o`)
* Время идей на обед (`LUNCH_TIME`, опционально, по умолчанию `13:00`)
* Время вечернего дайджеста (`BRIEF_TIME`, опционально, по умолчанию `20:00`)
* Путь к файлу задач (`TASKS_FILE`) или JSON в `TASKS_JSON` для полной настройки расписания

## Добавление бота в каналы и группы

1. Пригласите бота в нужный канал или группу.
2. Дайте ему права отправлять сообщения (администратор в каналах).
3. Отправьте тестовое сообщение в этот чат и откройте:

   ```
   https://api.telegram.org/bot<YOUR_TOKEN>/getUpdates
   ```

   В ответе JSON будет поле `chat.id` — это числовой ID канала.
4. Укажите полученное значение в переменной окружения `CHAT_ID` при запуске бота.

## Запуск локально

Установите необходимые переменные окружения и запустите бот:

```sh
export TELEGRAM_TOKEN=your_telegram_token
export CHAT_ID=123456789
export OPENAI_API_KEY=your_openai_key
export LUNCH_TIME=13:00
export BRIEF_TIME=20:00

# или загрузите задачи из файла
# export TASKS_FILE=tasks.yaml

go run main.go
```

После запуска планировщик автоматически отправит два ежедневных сообщения в указанное время. При старте бот также публикует сообщение «джарвис в сети, обновление произошло успешно», подтверждая успешный деплой. Каждый запрос к OpenAI имеет тайм‑аут 40 секунд. Перед созданием pull request запустите `gofmt -w -s` для форматирования кода и `go vet ./...` для проверки. Линтер можно установить командой `go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.63.0`, затем выполните `golangci-lint run`.

## Настройка задач

Бот читает дополнительные задачи из YAML-файла, путь к которому задаётся в переменной `TASKS_FILE`. Каждая задача должна содержать поле `time` в формате `HH:MM` и поле `prompt` с текстом сообщения.

Поддерживаемые переменные окружения и ключи:

- `TELEGRAM_TOKEN` – токен телеграм-бота
- `CHAT_ID` – числовой ID чата назначения
- `OPENAI_API_KEY` – ключ API OpenAI
- `OPENAI_MODEL` – имя модели OpenAI (опционально, по умолчанию `gpt-4o`)
- `LUNCH_TIME` – время для идей на обед
- `BRIEF_TIME` – время вечернего дайджеста
- `TASKS_FILE` – путь к YAML-файлу с пользовательскими заданиями

Пример `.env` и `tasks.yml`:

```ini
TELEGRAM_TOKEN=123456:ABC-DEF
CHAT_ID=123456789
OPENAI_API_KEY=sk-xxxxxxxx
OPENAI_MODEL=gpt-4o
LUNCH_TIME=12:00
BRIEF_TIME=18:00
TASKS_FILE=tasks.yml
```

```yaml
- time: "10:00"
  prompt: "земля: цена за сотку"
- time: "12:00"
  prompt: "микродействия"
- time: "13:00"
  prompt: "крипто тренд"
...
```

После указания переменных запустите бота командой:

```sh
go run main.go
```

## Развёртывание на сервере

1. Установите Go на сервер.
2. Клонируйте этот репозиторий.
3. Задайте переменные окружения, перечисленные выше.
4. Соберите бинарник командой `go build -o bot`.
5. Запустите `./bot` или настройте менеджер процессов, например `systemd`.

## Docker

Соберите образ для текущей платформы:

```sh
docker build -t telegram-bot .
```

Для сборки и публикации мультиархитектурного образа (linux/amd64 и linux/arm64) с помощью `buildx`:

```sh
docker buildx build --platform linux/amd64,linux/arm64 \
  -t your_dockerhub_user/telegram-bot:latest --push .
```

Запуск контейнера:

```sh
docker run -e TELEGRAM_TOKEN=your_token -e CHAT_ID=your_chat_id -e OPENAI_API_KEY=your_api_key \
  -e LUNCH_TIME=13:00 -e BRIEF_TIME=20:00 telegram-bot
```

Бота также можно запустить через `docker-compose`. Скопируйте `.env.example` в `.env`, заполните значения и запустите сервис. Переменная `DOCKERHUB_USER` в `.env` определяет аккаунт Docker Hub, используемый в `docker-compose.yml`:

```sh
cp .env.example .env
docker-compose up -d
```

## Развёртывание через GitHub Actions

В репозитории есть workflow GitHub Actions, который автоматически собирает и деплоит Docker-образ при каждом пуше в ветку `main`. Используется Docker Buildx для создания мультиархитектурного образа. Процесс включает следующие шаги:

1. Клонирование репозитория и компиляция Go-бинарника.
2. Сборка и публикация мультиплатформенного образа (linux/amd64 и linux/arm64) в Docker Hub.
3. Подключение к VPS по SSH и перезапуск контейнера через `docker-compose`.

Не забудьте настроить необходимые секреты в настройках репозитория:

* `DOCKERHUB_USER` и `DOCKERHUB_TOKEN` для публикации образа.
* `VPS_SSH_KEY`, `VPS_USER` и `VPS_HOST` для подключения к серверу.
* `TELEGRAM_TOKEN`, `OPENAI_API_KEY`, `CHAT_ID` и при необходимости `OPENAI_MODEL` для заполнения `.env` во время деплоя.

После завершения деплоя зайдите на VPS и выполните `docker ps`, чтобы убедиться, что контейнер запущен.

## Решение проблем

Контейнер завершит работу сразу, если не заданы обязательные переменные окружения:

* `TELEGRAM_TOKEN`
* `CHAT_ID` (числовой ID)
* `OPENAI_API_KEY`

Убедитесь, что эти значения переданы через окружение или указаны в файле `.env`. Корректный пример `.env`:

```ini
TELEGRAM_TOKEN=123456:ABC-DEF
CHAT_ID=123456789
OPENAI_API_KEY=sk-xxxxxxxx
OPENAI_MODEL=gpt-4o
LUNCH_TIME=13:00
BRIEF_TIME=20:00
```

Если контейнер не стартует, проверьте логи командой `docker logs <container>`, чтобы увидеть сообщения об ошибках.

## Лицензия

Проект распространяется на условиях [MIT License](LICENSE).
